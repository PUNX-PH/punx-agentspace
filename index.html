<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>D-ID Agent Stream</title>
  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
</head>
<body>
  <h2>D-ID Agent Stream Example</h2>
  <button onclick="startStream()">Start Conversation</button>
  <audio id="agent-audio" autoplay></audio>

  <script>
    const apiKey = 'ZXZhbmRlci5mb3h4QGRzaXRpcC5jb20:Lrn4LeZTHLAWCeQXAdfQ9'; // Replace with your D-ID API key
    const agentId = 'agt_Jd4BnTW4';   // Replace with your agent ID
    const userId = 'user-' + Math.random().toString(36).substring(2, 15);
    const socketUrl = 'wss://stream.d-id.com';

    async function startStream() {
      // Get JWT Token
      const response = await fetch('https://api.d-id.com/auth/token', {
        method: 'GET',
        headers: { Authorization: `Basic ${btoa(apiKey + ':')}` }
      });

      const { token } = await response.json();

      const socket = io(socketUrl, {
        path: '/agent',
        auth: { token },
        transports: ['websocket']
      });

      socket.on('connect', () => {
        console.log('Connected to D-ID stream');

        socket.emit('start', {
          type: 'agent',
          agentId,
          userId,
          session: {
            voice: { speed: 1 },
            config: { audio: true }
          }
        });

        // Optional: Send initial user message
        socket.emit('talk', { text: 'Hello, how can you help me today?' });
      });

      socket.on('audio', (data) => {
        const audioBlob = new Blob([data.audio], { type: 'audio/mpeg' });
        const audioUrl = URL.createObjectURL(audioBlob);
        document.getElementById('agent-audio').src = audioUrl;
      });

      socket.on('message', (data) => {
        console.log('Agent message:', data);
      });

      socket.on('disconnect', () => {
        console.log('Disconnected from D-ID');
      });
    }
  </script>
</body>
</html>
